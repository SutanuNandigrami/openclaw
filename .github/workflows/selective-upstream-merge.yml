concurrency:
  group: selective-upstream-merge
  cancel-in-progress: false

name: Selective Upstream Merge

on:
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: "Upstream repo (owner/repo or URL)"
        required: false
      pr_numbers:
        description: "Comma-separated PR numbers (optional)"
        required: false
      required_label:
        description: "Only merge PRs with this label (optional)"
        required: false
      allowed_authors:
        description: "Comma-separated GitHub usernames (optional)"
        required: false
      dry_run:
        description: "Dry run (true = preview only)"
        required: true
        default: "true"

  schedule:
    - cron: "0 */6 * * *"

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y gh jq

      - name: Authenticate gh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Normalize upstream
        id: upstream
        run: |
          set -euo pipefail
          raw="${{ inputs.upstream_repo || github.event.repository.parent.full_name }}"
          repo="${raw#https://github.com/}"
          repo="${repo%.git}"
          [[ "$repo" =~ ^[^/]+/[^/]+$ ]] || exit 1
          echo "repo=$repo" >> "$GITHUB_OUTPUT"
          echo "owner=${repo%%/*}" >> "$GITHUB_OUTPUT"

      - name: Collect PRs
        id: prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          manual="${{ inputs.pr_numbers }}"
          label="${{ inputs.required_label }}"
          authors="${{ inputs.allowed_authors }}"
          upstream="${{ steps.upstream.outputs.repo }}"
          > prs.txt

          [[ -n "$manual" || -n "$label" || -n "$authors" ]] || exit 0

          if [[ -n "$manual" ]]; then
            echo "$manual" | tr ',' '\n' | grep -E '^[0-9]+$' | sed 's/^/PR:/' >> prs.txt
          else
            gh pr list --repo "$upstream" --state open \
              --json number,labels,author,isDraft,mergeable \
            | jq -r '
                .[]
                | select(.isDraft==false)
                | select(.mergeable=="MERGEABLE")
                | select(
                    ("'"$label"'"!="" and (.labels[].name=="'"$label"'"))
                    or
                    ("'"$authors"'"!="" and (.author.login|inside("'"$authors"'")))
                  )
                | "PR:\(.number)"
              ' >> prs.txt
          fi

          echo "prs<<EOF" >> "$GITHUB_OUTPUT"
          cat prs.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Dry run preview
        if: inputs.dry_run == 'true' || github.event_name == 'schedule'
        run: |
          echo "DRY RUN"
          echo "${{ steps.prs.outputs.prs }}"

      - name: Merge upstream PRs (squash, safe)
        if: inputs.dry_run != 'true' && github.event_name != 'schedule'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          upstream="${{ steps.upstream.outputs.repo }}"
          base="${{ github.event.repository.default_branch }}"

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git fetch origin "$base"
          git checkout "$base"

          while read -r line; do
            [[ -z "$line" ]] && continue
            pr="${line#PR:}"

            echo "▶ Processing PR #$pr"

            backup="backup-before-pr-$pr-$(date +%s)"
            git branch "$backup"
            git push origin "$backup"

            if ! git fetch "https://github.com/$upstream.git" "pull/$pr/head:pr-$pr"; then
              gh pr comment "$pr" --repo "$upstream" \
                --body "❌ Failed to fetch commits for PR #$pr"
              continue
            fi

            if git merge --squash "pr-$pr"; then
              git commit -m "Squash merge upstream PR #$pr"
              git push origin "$base"
              git tag "upstream-pr-$pr"
              git push origin "upstream-pr-$pr"

              gh pr comment "$pr" --repo "$upstream" \
                --body "✅ PR #$pr merged (squashed) into fork.\nTag: upstream-pr-$pr"
            else
              git reset --hard
              git checkout "$backup"
              git checkout "$base"
              git reset --hard "$backup"
              git push origin "$base" --force-with-lease

              gh pr comment "$pr" --repo "$upstream" \
                --body "❌ Merge conflict while processing PR #$pr. No changes applied."
            fi

          done <<< "${{ steps.prs.outputs.prs }}"
